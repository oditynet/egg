{% extends "base.html" %}

{% block title %}–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ - –Ø–π—Ü–æ{% endblock %}

{% block content %}
<div class="seller-dashboard">
    <h2 class="section__title">–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞</h2>
    
    <div class="dashboard__tabs">
        <div class="dashboard__tab dashboard__tab--active" onclick="switchTab('addProduct')">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
        <div class="dashboard__tab" onclick="switchTab('orders')">–ó–∞–∫–∞–∑—ã</div>
        <div class="dashboard__tab" onclick="switchTab('notifications')">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    </div>
    
    <div id="addProductTab" class="dashboard__content dashboard__content--active">
        <form class="add-product-form" id="addProductForm" enctype="multipart/form-data">
            <div class="form__group">
                <label class="form__label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                <input type="text" class="form__input" id="productName" name="name" required>
            </div>
            
            <div class="form__group">
                <label class="form__label">–¶–µ–Ω–∞ (—Ä—É–±.) *</label>
                <input type="number" class="form__input" id="productPrice" name="price" min="1" step="0.01" required>
            </div>
            
            <div class="form__group">
                <label class="form__label">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                <textarea class="form__input" id="productDescription" name="description" rows="4" required placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
            </div>
            
            <div class="form__group">
                <label class="form__label">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ * (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                <textarea class="form__input" id="productFeatures" name="features" rows="4" required placeholder="–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä: Intel Core i5
–ü–∞–º—è—Ç—å: 8 –ì–ë
–î–∏—Å–∫: 512 –ì–ë SSD
–≠–∫—Ä–∞–Ω: 15.6 –¥—é–π–º–æ–≤"></textarea>
            </div>
            
            <div class="form__group">
                <label class="form__label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ * (–º–∞–∫—Å–∏–º—É–º 5 —Ñ–∞–π–ª–æ–≤)</label>
                <input type="file" class="form__input" id="productImages" name="images" multiple accept="image/*" required>
                <small class="form-help">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–∞. –§–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF</small>
            </div>
            
            <button type="submit" class="btn btn--primary" id="submitBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </form>
        
        <div id="addProductMessage" class="message" style="display: none;"></div>
    </div>
    
    <div id="ordersTab" class="dashboard__content">
        <div class="orders-list">
            {% if orders %}
                {% for order in orders %}
                <div class="order-item">
                    <div class="order-item__header">
                        <div><strong>–ó–∞–∫–∞–∑ #{{ order.order_number }}</strong></div>
                        <div>{{ order.created_at[:16] }}</div>
                    </div>
                    
                    <div class="order-item__products">
                        {% set order_products = order.products|from_json %}
                        {% for product in order_products %}
                            <div class="order-product">
                                <span class="order-product__name">{{ product.name }}</span>
                                <span class="order-product__details">{{ product.quantity }} —à—Ç. √ó {{ product.price }} —Ä—É–±.</span>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="order-item__status">
                        <span class="status-badge status-badge--{{ order.status }}">
                            {% if order.status == 'payment' %}–û–ø–ª–∞—Ç–∞
                            {% elif order.status == 'shipping' %}–û—Ç–ø—Ä–∞–≤–∫–∞
                            {% elif order.status == 'delivery' %}–î–æ—Å—Ç–∞–≤–∫–∞
                            {% elif order.status == 'received' %}–ü–æ–ª—É—á–µ–Ω
                            {% else %}{{ order.status }}{% endif %}
                        </span>
                        <span class="order-total">–û–±—â–∞—è —Å—É–º–º–∞: <strong>{{ order.total_price }} —Ä—É–±.</strong></span>
                    </div>
                    
                    <div class="order-address">
                        <strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> {{ order.address }}
                    </div>
                    
                    {% if order.status == 'delivery' and order.verification_code %}
                    <div class="delivery-verification">
                        <div class="verification-info">
                            <h4>‚úÖ –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω –≤ –¥–æ—Å—Ç–∞–≤–∫—É</h4>
                            <p><strong>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</strong> 
                               <span class="verification-code">{{ order.verification_code }}</span>
                            </p>
                            <p class="verification-help">–ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ–±—â–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–¥ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞</p>
                        </div>
                        
                        <div class="verification-form">
                            <h4>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è</h4>
                            <div class="form-group">
                                <input type="text" id="delivery_code_{{ order.id }}" 
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞" class="form-input">
                                <button class="btn btn--secondary" onclick="verifyDelivery({{ order.id }})">
                                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if order.status == 'received' %}
                    <div class="delivery-completed">
                        <div class="status-badge status-badge--delivered">
                            ‚úÖ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–º
                        </div>
                        <p class="completed-time">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: {{ order.updated_at[:16] }}</p>
                    </div>
                    {% endif %}
                    
                    {% if order.status in ['payment', 'shipping'] %}
                    <div class="order-item__actions">
                        <select id="status_{{ order.id }}">
                            <option value="payment" {% if order.status == 'payment' %}selected{% endif %}>–û–ø–ª–∞—Ç–∞</option>
                            <option value="shipping" {% if order.status == 'shipping' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–∫–∞</option>
                            <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                        </select>
                        <button class="btn btn--secondary" onclick="updateOrderStatus({{ order.id }})">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-orders">
                    <div class="empty-orders__icon">üì¶</div>
                    <h3 class="empty-orders__title">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p class="empty-orders__text">–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑—ã, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="notificationsTab" class="dashboard__content">
        <div class="notifications-section">
            <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {% if unread_count > 0 %}<span class="notification-badge">{{ unread_count }}</span>{% endif %}</h3>
            
            <div class="notifications-list">
                {% if notifications %}
                    {% for notification in notifications %}
                    <div class="notification-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
                        <div class="notification-content">
                            <p class="notification-message">{{ notification.message }}</p>
                            <span class="notification-order">–ó–∞–∫–∞–∑ #{{ notification.order_number }}</span>
                            <span class="notification-time">{{ notification.created_at[:16] }}</span>
                        </div>
                        {% if not notification.is_read %}
                        <button class="mark-read-btn" onclick="markNotificationRead({{ notification.id }})">‚úì</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.dashboard__content').forEach(tab => {
            tab.classList.remove('dashboard__content--active');
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName + 'Tab').classList.add('dashboard__content--active');
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.querySelectorAll('.dashboard__tab').forEach(tab => {
            tab.classList.remove('dashboard__tab--active');
        });
        document.querySelector(`.dashboard__tab:nth-child(${tabName === 'addProduct' ? 1 : tabName === 'orders' ? 2 : 3})`).classList.add('dashboard__tab--active');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const submitBtn = document.getElementById('submitBtn');
        const messageDiv = document.getElementById('addProductMessage');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        const name = formData.get('name');
        const price = formData.get('price');
        const description = formData.get('description');
        const features = formData.get('features');
        const images = formData.get('images');
        
        if (!name || !price || !description || !features) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        if (parseFloat(price) <= 0) {
            showMessage('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0', 'error');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        submitBtn.disabled = true;
        submitBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        messageDiv.style.display = 'none';
        
        try {
            const response = await fetch('{{ url_for("add_product") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ID: ' + data.product_id, 'success');
                form.reset();
            } else {
                showMessage('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
        }
    });

    function showMessage(text, type) {
        const messageDiv = document.getElementById('addProductMessage');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';
        
        messageDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function updateOrderStatus(orderId) {
        const status = document.getElementById('status_' + orderId).value;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('status', status);
        
        fetch('{{ url_for("update_order_status") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.verification_code) {
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω! –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: ' + data.verification_code);
                } else {
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                }
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        });
    }

    function verifyDelivery(orderId) {
        const code = document.getElementById('delivery_code_' + orderId).value;
        
        if (!code) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞');
            return;
        }
        
        if (code.length !== 6 || isNaN(code)) {
            alert('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä');
            return;
        }
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('code', code);
        
        fetch('{{ url_for("verify_delivery") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function markNotificationRead(notificationId) {
        fetch('{{ url_for("mark_notification_read") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'notification_id=' + notificationId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`.notification-item[data-id="${notificationId}"]`).classList.remove('unread');
                document.querySelector(`.notification-item[data-id="${notificationId}"] .mark-read-btn`).remove();
                location.reload();
            }
        });
    }
</script>

<style>
.add-product-form {
    background: white;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    max-width: 600px;
    margin: 0 auto;
}

.form-help {
    color: #666;
    font-size: 12px;
    display: block;
    margin-top: 5px;
}

.message {
    padding: 15px;
    border-radius: var(--border-radius);
    margin: 20px 0;
    text-align: center;
    font-weight: 500;
}

.message.success {
    background-color: var(--success-color);
    color: white;
}

.message.error {
    background-color: var(--error-color);
    color: white;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.notifications-section {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
}

.notification-badge {
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    padding: 2px 8px;
    font-size: 12px;
}

.notification-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s;
}

.notification-item.unread {
    background-color: #f8f9fa;
    border-left: 4px solid var(--accent-color);
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-content {
    flex: 1;
}

.notification-message {
    margin: 0 0 5px 0;
    font-weight: 500;
}

.notification-order {
    color: #666;
    font-size: 14px;
    margin-right: 10px;
}

.notification-time {
    color: #999;
    font-size: 12px;
}

.mark-read-btn {
    background: var(--success-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 16px;
}

.mark-read-btn:hover {
    background: #28a745;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .add-product-form {
        padding: 20px;
        margin: 0;
    }
    
    .dashboard__tabs {
        flex-direction: column;
    }
    
    .dashboard__tab {
        text-align: center;
        border-bottom: 1px solid #eee;
    }
    
    .dashboard__tab--active {
        border-bottom: 2px solid var(--accent-color);
    }
    
    .notification-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .mark-read-btn {
        align-self: flex-end;
    }
}
</style>
{% endblock %}

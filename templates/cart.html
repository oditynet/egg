{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - –Ø–π—Ü–æ{% endblock %}

{% block content %}
<div class="cart-page">
    <h2 class="section__title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
    
    <div class="cart-items">
        {% if cart_items %}
            {% for item in cart_items %}
            <div class="cart-item">
                <div class="cart-item__checkbox">
                    <input type="checkbox" id="item_{{ item.product_id }}" 
                           data-product-id="{{ item.product_id }}"
                           class="cart-item-select" 
                           {% if item.selected %}checked{% endif %}>
                </div>
                
                <img src="{{ item.images.split('\n')[0] if item.images else url_for('static', filename='images/placeholder.jpg') }}" 
                     alt="{{ item.name }}" class="cart-item__image">
                
                <div class="cart-item__content">
                    <div class="cart-item__info">
                        <div class="cart-item__title">{{ item.name }}</div>
                        <div class="cart-item__price">{{ item.price }} —Ä—É–±. –∑–∞ —à—Ç.</div>
                        
                        <div class="cart-item__quantity">
                            <button class="quantity-btn" onclick="updateQuantity({{ item.product_id }}, {{ item.quantity - 1 }})">-</button>
                            <span class="quantity-value">{{ item.quantity }} —à—Ç.</span>
                            <button class="quantity-btn" onclick="updateQuantity({{ item.product_id }}, {{ item.quantity + 1 }})">+</button>
                        </div>
                        
                        <div class="cart-item__total">
                            –ò—Ç–æ–≥–æ: <strong>{{ item.price * item.quantity }} —Ä—É–±.</strong>
                        </div>
                    </div>
                    
                    <div class="cart-item__actions">
                        <button class="cart-item__remove" onclick="removeFromCart({{ item.product_id }})">
                            <span>√ó</span> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-cart">
                <div class="empty-cart__icon">üõí</div>
                <h3 class="empty-cart__title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                <p class="empty-cart__text">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É</p>
                <a href="{{ url_for('index') }}" class="btn btn--primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
            </div>
        {% endif %}
    </div>
    
    {% if cart_items %}
    <div class="cart-summary">
        <div class="cart-total">
            <div class="total-line">
                <span>–¢–æ–≤–∞—Ä–æ–≤ –≤—ã–±—Ä–∞–Ω–æ:</span>
                <span id="selectedItemsCount">0</span>
            </div>
            <div class="total-line">
                <span>–û–±—â–∞—è —Å—É–º–º–∞:</span>
                <span class="cart-total__price" id="selectedTotalPrice">0 —Ä—É–±.</span>
            </div>
            <button class="cart-total__btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</button>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function updateQuantity(productId, newQuantity) {
        if (newQuantity < 1) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
                removeFromCart(productId);
            }
            return;
        }
        
        fetch('{{ url_for("update_cart_quantity") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'product_id=' + productId + '&quantity=' + newQuantity
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function removeFromCart(productId) {
        fetch('{{ url_for("remove_from_cart") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'product_id=' + productId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }

    function checkout() {
        const selectedItems = document.querySelectorAll('.cart-item-select:checked');
        if (selectedItems.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            return;
        }

        fetch('{{ url_for("checkout") }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ù–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞: ' + data.order_number);
                window.location.href = '{{ url_for("orders") }}';
            } else {
                alert(data.message);
            }
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤
    document.querySelectorAll('.cart-item-select').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const productId = this.getAttribute('data-product-id');
            const selected = this.checked;
            
            fetch('{{ url_for("update_cart_selection") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'product_id=' + productId + '&selected=' + selected
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message);
                    this.checked = !selected;
                } else {
                    updateCartSummary();
                }
            });
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
    function updateCartSummary() {
        let totalPrice = 0;
        let selectedCount = 0;
        
        document.querySelectorAll('.cart-item').forEach(item => {
            const checkbox = item.querySelector('.cart-item-select');
            if (checkbox.checked) {
                const price = parseFloat(item.querySelector('.cart-item__price').textContent.replace(' —Ä—É–±. –∑–∞ —à—Ç.', ''));
                const quantity = parseInt(item.querySelector('.quantity-value').textContent.replace(' —à—Ç.', ''));
                totalPrice += price * quantity;
                selectedCount++;
            }
        });
        
        document.getElementById('selectedItemsCount').textContent = selectedCount;
        document.getElementById('selectedTotalPrice').textContent = totalPrice.toFixed(2) + ' —Ä—É–±.';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        updateCartSummary();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
        document.querySelectorAll('.cart-item-select').forEach(checkbox => {
            checkbox.addEventListener('change', updateCartSummary);
        });
    });
</script>

<style>
.cart-summary {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-top: 20px;
}

.total-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.total-line:last-child {
    border-bottom: none;
    font-weight: bold;
    font-size: 18px;
}

.cart-item__total {
    margin-top: 10px;
    font-weight: bold;
    color: var(--accent-color);
}

.cart-item__quantity {
    display: flex;
    align-items: center;
    margin: 10px 0;
    gap: 10px;
}

.quantity-btn {
    width: 30px;
    height: 30px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quantity-btn:hover {
    background: var(--secondary-color);
}

.quantity-value {
    margin: 0 10px;
    font-weight: bold;
    min-width: 30px;
    text-align: center;
}

@media (max-width: 768px) {
    .cart-item {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
    }
    
    .cart-item__checkbox {
        padding: 5px;
        margin-bottom: 10px;
    }
    
    .cart-item__image {
        width: 100%;
        height: 150px;
        margin-bottom: 10px;
    }
    
    .cart-item__content {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 0;
        width: 100%;
    }
    
    .cart-item__info {
        width: 100%;
    }
    
    .cart-item__actions {
        margin-left: 0;
        width: 100%;
    }
    
    .cart-item__remove {
        width: 100%;
        text-align: center;
    }
    
    .cart-item__quantity {
        justify-content: center;
    }
}
</style>
{% endblock %}
